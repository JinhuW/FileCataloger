#!/usr/bin/env sh

# Pre-stage hook: Runs code review before files are staged
# This hook can be bypassed with: SKIP_REVIEW=1 git add ...

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
REVIEW_CACHE_DIR=".claude/review-cache"
REVIEW_LOG_FILE=".claude/review.log"
MAX_FILES_PER_REVIEW=10

# Check if review should be skipped
if [ "$SKIP_REVIEW" = "1" ] || [ "$SKIP_REVIEW" = "true" ]; then
    echo -e "${YELLOW}âš ï¸  Code review skipped (SKIP_REVIEW is set)${NC}"
    exit 0
fi

# Check if running in CI environment
if [ "$CI" = "true" ]; then
    echo -e "${BLUE}â„¹ï¸  Running in CI environment - code review skipped${NC}"
    exit 0
fi

echo -e "${CYAN}ğŸ¤– FileCataloger Pre-Stage Code Review${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Create review cache directory if it doesn't exist
mkdir -p "$REVIEW_CACHE_DIR"

# Get the list of modified files that would be staged
FILES_TO_REVIEW=""
REVIEW_NEEDED=false

# Check if we're in the middle of a git operation
if [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
    echo -e "${YELLOW}âš ï¸  Git rebase in progress - review skipped${NC}"
    exit 0
fi

# Determine which files need review
if [ "$#" -eq 0 ]; then
    # No specific files provided, check all modified files
    FILES_TO_REVIEW=$(git diff --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$' | head -n $MAX_FILES_PER_REVIEW)
else
    # Specific files provided
    for file in "$@"; do
        if [ -f "$file" ] && echo "$file" | grep -qE '\.(ts|tsx|js|jsx)$'; then
            FILES_TO_REVIEW="$FILES_TO_REVIEW$file\n"
        fi
    done
    FILES_TO_REVIEW=$(echo -e "$FILES_TO_REVIEW" | head -n $MAX_FILES_PER_REVIEW)
fi

# Count files to review
FILE_COUNT=$(echo "$FILES_TO_REVIEW" | grep -c '^' || echo 0)

if [ "$FILE_COUNT" -eq 0 ]; then
    echo -e "${GREEN}âœ… No TypeScript/JavaScript files to review${NC}"
    exit 0
fi

echo -e "${BLUE}ğŸ“‹ Files to review ($FILE_COUNT files):${NC}"
echo "$FILES_TO_REVIEW" | while IFS= read -r file; do
    [ -n "$file" ] && echo "   â€¢ $file"
done

# Function to generate cache key for a file
generate_cache_key() {
    local file="$1"
    local file_hash=$(git hash-object "$file" 2>/dev/null || shasum -a 256 "$file" | cut -d' ' -f1)
    echo "${file//\//_}_$file_hash"
}

# Function to check if review is cached and still valid
is_review_cached() {
    local file="$1"
    local cache_key=$(generate_cache_key "$file")
    local cache_file="$REVIEW_CACHE_DIR/$cache_key.review"

    if [ -f "$cache_file" ]; then
        # Check if cache is less than 1 hour old
        if [ "$(find "$cache_file" -mmin +60 2>/dev/null)" ]; then
            return 1  # Cache is too old
        fi
        return 0  # Cache is valid
    fi
    return 1  # No cache
}

# Function to run code review using Claude Code
run_code_review() {
    local file="$1"
    local cache_key=$(generate_cache_key "$file")
    local cache_file="$REVIEW_CACHE_DIR/$cache_key.review"

    echo -e "${CYAN}  ğŸ” Reviewing: $file${NC}"

    # Check cache first
    if is_review_cached "$file"; then
        echo -e "${GREEN}  âœ“ Using cached review${NC}"
        cat "$cache_file"
        return 0
    fi

    # Create a temporary review request file
    local temp_request="/tmp/claude_review_$$_$(date +%s).md"

    cat > "$temp_request" << EOF
Please review the following file for code quality, focusing on:
- TypeScript/JavaScript best practices
- Electron-specific concerns (if applicable)
- Security issues
- Performance problems
- Code maintainability

File: $file

\`\`\`$(echo "$file" | sed 's/.*\.//')
$(cat "$file")
\`\`\`

Provide a brief summary of any critical issues that should be addressed before committing.
Use the code-reviewer agent to analyze this code.
EOF

    # Run the review (this is a placeholder for actual Claude Code integration)
    # In production, this would call Claude Code API or CLI
    local review_output=""

    # For now, run basic checks as a fallback
    echo -e "${YELLOW}  âš¡ Running automated checks...${NC}"

    # TypeScript check for this specific file
    if echo "$file" | grep -qE '\.(ts|tsx)$'; then
        if ! npx tsc --noEmit --skipLibCheck "$file" 2>/dev/null; then
            echo -e "${RED}  âŒ TypeScript errors detected${NC}"
            REVIEW_NEEDED=true
        fi
    fi

    # ESLint check for this specific file
    if npx eslint "$file" --format compact 2>/dev/null | grep -q "Error"; then
        echo -e "${RED}  âŒ ESLint errors detected${NC}"
        REVIEW_NEEDED=true
    fi

    # Check for common issues
    if grep -q "console\.log" "$file"; then
        echo -e "${YELLOW}  âš ï¸  console.log found (use Logger module instead)${NC}"
    fi

    if grep -q "any" "$file" && echo "$file" | grep -qE '\.(ts|tsx)$'; then
        echo -e "${YELLOW}  âš ï¸  'any' type detected (consider specific types)${NC}"
    fi

    if grep -qE "TODO|FIXME|XXX" "$file"; then
        echo -e "${YELLOW}  âš ï¸  TODO/FIXME comments found${NC}"
    fi

    # Cache the review result
    echo "Review completed: $(date)" > "$cache_file"

    # Clean up
    rm -f "$temp_request"

    return 0
}

# Main review loop
echo ""
echo -e "${CYAN}ğŸ”„ Starting code review...${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

FAILED_FILES=""
for file in $FILES_TO_REVIEW; do
    [ -z "$file" ] && continue

    if ! run_code_review "$file"; then
        FAILED_FILES="$FAILED_FILES$file\n"
    fi
    echo ""
done

# Clean up old cache files (older than 24 hours)
find "$REVIEW_CACHE_DIR" -name "*.review" -mtime +1 -delete 2>/dev/null

# Summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ -n "$FAILED_FILES" ]; then
    echo -e "${RED}âŒ Review found issues in:${NC}"
    echo -e "$FAILED_FILES"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  1. Fix the issues and try again"
    echo "  2. Run with SKIP_REVIEW=1 to bypass (not recommended)"
    echo "  3. Use --no-verify flag with git add"
    exit 1
else
    if [ "$REVIEW_NEEDED" = true ]; then
        echo -e "${YELLOW}âš ï¸  Review completed with warnings${NC}"
        echo "Consider addressing the warnings before committing."
        echo ""
        echo -e "${BLUE}Proceeding with staging...${NC}"
    else
        echo -e "${GREEN}âœ… Code review passed successfully!${NC}"
    fi
fi

exit 0