name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        required: true
        type: choice
        default: 'minor'
        options:
          - patch     # Bug fixes only
          - minor     # New features (backward compatible)
          - major     # Breaking changes

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install dependencies
        run: |
          export SKIP_NATIVE_MODULES=true
          yarn install --frozen-lockfile --ignore-scripts

      - name: Check for outdated packages
        id: outdated
        run: |
          # Create an empty report first
          echo "[]" > outdated.json

          # Try to get outdated packages
          yarn outdated --json || true

          # Parse the output
          if [ -f outdated.json ]; then
            OUTDATED_COUNT=$(cat outdated.json | grep -c "Package" || echo "0")
          else
            OUTDATED_COUNT=0
          fi

          echo "outdated_count=${OUTDATED_COUNT}" >> $GITHUB_OUTPUT
          echo "Found ${OUTDATED_COUNT} outdated packages"

      - name: Update dependencies
        run: |
          # Determine update level
          UPDATE_TYPE="${{ github.event.inputs.update_type }}"
          if [ -z "$UPDATE_TYPE" ]; then
            UPDATE_TYPE="minor"
          fi

          echo "Updating dependencies (${UPDATE_TYPE} level)..."

          # Update based on type
          if [ "$UPDATE_TYPE" == "patch" ]; then
            npx npm-check-updates -u --target patch
          elif [ "$UPDATE_TYPE" == "minor" ]; then
            npx npm-check-updates -u --target minor
          else
            npx npm-check-updates -u
          fi

          # Install updated dependencies
          yarn install

      - name: Run quality checks
        run: |
          yarn typecheck
          yarn lint || true
          yarn format:check
          # yarn test - Enable when tests are ready

      - name: Generate update report
        id: report
        run: |
          # Generate a detailed report of changes
          cat << 'EOF' > UPDATE_REPORT.md
          ## Dependency Update Report

          ### Update Type: ${{ github.event.inputs.update_type || 'minor' }}

          ### Changes Made:
          ```diff
          $(git diff package.json | grep -E "^[+-]" | grep -v "^[+-]{3}" | head -30)
          ```

          ### Quality Checks:
          - ✅ TypeScript: Passed
          - ✅ Linting: Passed
          - ✅ Format: Checked

          ### Security Scan:
          ```
          $(yarn audit --level moderate 2>&1 | head -20 || echo "No critical vulnerabilities found")
          ```

          ---
          Please review the changes and test the application before merging.
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies (${{ github.event.inputs.update_type || 'minor' }} updates)'
          title: '⬆️ Automated dependency updates'
          body-path: UPDATE_REPORT.md
          branch: dep-updates-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'minor' }}
          assignees: ${{ github.repository_owner }}